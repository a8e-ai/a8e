on:
  workflow_call:
    inputs:
      version:
        required: false
        default: ""
        type: string
      ref:
        type: string
        required: false
        default: ""

name: "Build CLI"

jobs:
  build-cli:
    name: Build CLI (${{ matrix.architecture }}-${{ matrix.target-suffix }})
    runs-on: ${{ matrix.build-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            architecture: x86_64
            target-suffix: unknown-linux-gnu
            build-on: ubuntu-latest
            use-cross: true
          - os: linux
            architecture: aarch64
            target-suffix: unknown-linux-gnu
            build-on: ubuntu-latest
            use-cross: true
          - os: macos
            architecture: aarch64
            target-suffix: apple-darwin
            build-on: macos-latest
            use-cross: false
          - os: macos
            architecture: x86_64
            target-suffix: apple-darwin
            build-on: macos-13
            use-cross: false
          - os: windows
            architecture: x86_64
            target-suffix: pc-windows-msvc
            build-on: windows-latest
            use-cross: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rustflags: ""

      - name: Update version in Cargo.toml
        if: ${{ inputs.version != '' }}
        shell: bash
        run: |
          VERSION="${{ inputs.version }}"
          # Strip build metadata (+...) as Cargo doesn't support it in workspace version
          VERSION_CLEAN=$(echo "$VERSION" | sed 's/+.*//')
          sed -i.bak "s/^version = \".*\"/version = \"${VERSION_CLEAN}\"/" Cargo.toml
          rm -f Cargo.toml.bak

      - name: Install cross (Linux)
        if: matrix.use-cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.architecture }}-${{ matrix.target-suffix }}

      - name: Add target
        shell: bash
        run: rustup target add ${{ matrix.architecture }}-${{ matrix.target-suffix }}

      - name: Build CLI (cross - Linux)
        if: matrix.use-cross
        env:
          CROSS_NO_WARNINGS: 0
        run: |
          export TARGET="${{ matrix.architecture }}-${{ matrix.target-suffix }}"
          cross build --release --target ${TARGET} -p a8e

      - name: Build CLI (native - macOS/Windows)
        if: ${{ !matrix.use-cross }}
        shell: bash
        run: |
          export TARGET="${{ matrix.architecture }}-${{ matrix.target-suffix }}"
          cargo build --release --target ${TARGET} -p a8e

      - name: Package CLI (Unix)
        if: matrix.os != 'windows'
        shell: bash
        run: |
          export TARGET="${{ matrix.architecture }}-${{ matrix.target-suffix }}"
          mkdir -p "target/${TARGET}/release/a8e-package"
          cp "target/${TARGET}/release/a8e" "target/${TARGET}/release/a8e-package/"
          cd "target/${TARGET}/release"
          tar -cjf "a8e-${TARGET}.tar.bz2" -C a8e-package .
          echo "ARTIFACT=target/${TARGET}/release/a8e-${TARGET}.tar.bz2" >> $GITHUB_ENV

      - name: Package CLI (Windows)
        if: matrix.os == 'windows'
        shell: bash
        run: |
          export TARGET="${{ matrix.architecture }}-${{ matrix.target-suffix }}"
          mkdir -p "target/${TARGET}/release/a8e-package"
          cp "target/${TARGET}/release/a8e.exe" "target/${TARGET}/release/a8e-package/"
          cd "target/${TARGET}/release"
          7z a -tzip "a8e-${TARGET}.zip" a8e-package/
          echo "ARTIFACT=target/${TARGET}/release/a8e-${TARGET}.zip" >> $GITHUB_ENV

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: a8e-${{ matrix.architecture }}-${{ matrix.target-suffix }}
          path: ${{ env.ARTIFACT }}
